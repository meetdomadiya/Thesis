<?php
$translate = $this->plugin('translate');
$escape = $this->plugin('escapeHtml');
$this->headLink()->appendStylesheet($this->assetUrl('css/resource-page-blocks.css', 'Omeka'));

// TEI Publisher CSS + JS
$this->headLink()->appendStylesheet('http://127.0.0.1:8080/exist/apps/tei-publisher/resources/css/theme.css');
echo '<script type="module" src="http://127.0.0.1:8080/exist/apps/tei-publisher/resources/scripts/pb-components-bundle.js"></script>';

$this->htmlElement('body')->appendAttribute('class', 'item resource show');
$filterLocale = (bool) $this->siteSetting('filter_locale_values');
$lang = $this->lang();
$valueLang = $filterLocale ? [$lang, ''] : null;

$itemId = $item->id();

// Regions
$mainBlockContent = $this->resourcePageBlocks($item);
$mainHasBlocks = $mainBlockContent->hasBlocks();
$leftSidebarBlockContent = $this->resourcePageBlocks($item, 'left');
$leftSidebarHasBlocks = $leftSidebarBlockContent->hasBlocks();
$rightSidebarBlockContent = $this->resourcePageBlocks($item, 'right');
$rightSidebarHasBlocks = $rightSidebarBlockContent->hasBlocks();
?>

<?php echo $this->ResourceTags($item); ?>
<?php echo $this->pageTitle($item->displayTitle(null, $valueLang), 1); ?>
<?php $this->trigger('view.show.before'); ?>

<?php if ($mainHasBlocks || $leftSidebarHasBlocks || $rightSidebarHasBlocks): ?>
<?php
$additionalContainerClasses = '';
if ($mainHasBlocks && $leftSidebarHasBlocks && $rightSidebarHasBlocks) {
    $additionalContainerClasses = 'regions-container--all';
} elseif ($mainHasBlocks && !$leftSidebarHasBlocks && !$rightSidebarHasBlocks) {
    $additionalContainerClasses = 'regions-container--main';
}
?>
<div class="regions-container <?php echo $additionalContainerClasses; ?>">
<?php if ($leftSidebarHasBlocks && $blockContent = $leftSidebarBlockContent->getBlocks()): ?>
<div class="sidebar-region sidebar-region--left">
<div class="metadata">
<?php echo $blockContent; ?>
</div>
</div>
<?php endif; ?>

<?php if ($mainHasBlocks && $blockContent = $mainBlockContent->getBlocks()): ?>
<div class="main-region">
<div class="metadata">
<?php echo $blockContent; ?>
</div>
</div>
<?php endif; ?>

<?php if ($rightSidebarHasBlocks && $blockContent = $rightSidebarBlockContent->getBlocks()): ?>
<div class="sidebar-region sidebar-region--right">
<div class="metadata">
<?php echo $blockContent; ?>
</div>
</div>
<?php endif; ?>
</div>
<?php endif; ?>


<!-- TEI Publisher Integration -->
<div class="tei-publisher-container" style="margin-top: 2em; padding: 1em; border: 1px solid #ddd; border-radius: 8px;">
    <h3>TEI Document Viewer</h3>
    
    <!-- Viewer -->
    <pb-page endpoint="http://127.0.0.1:8080/exist/apps/tei-publisher/" url-path="query" api-version="1.0.0" lang="en">
        <pb-document 
            id="document1" 
            path="test/item_<?php echo $itemId; ?>.xml" 
            odd="shakespeare" 
            view="page">
        </pb-document>

        <pb-view 
            id="view1" 
            src="document1"
            subscribe="document1"
            style="min-height: 400px; border: 1px solid #eee; padding: 1em;">
        </pb-view>
    </pb-page>

    <!-- Simple link to open editor in new tab -->
    <div style="margin-top:1em;">
        <pb-edit-xml path="/db/apps/tei-publisher/data/test/item_<?php echo $itemId; ?>.xml">View Documentation</pb-edit-xml>
    </div>
</div>

<?php $this->trigger('view.show.after'); ?>

<style>
.tei-publisher-container {
    background-color: #f8f9fa;
}
.btn {
    padding: 8px 16px;
    margin: 0 4px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    background-color: #007bff;
    color: white;
    text-decoration: none;
}
.btn:hover {
    opacity: 0.9;
}
pb-view {
    display: block;
    width: 100%;
}
</style>
